# パフォーマンス

## 実行ティア

zwasm は階層型実行を採用しています:

1. **インタープリタ**: すべての関数はレジスタ IR として開始され、ディスパッチループで実行されます。起動が速く、コンパイルのオーバーヘッドがありません。
2. **JIT (ARM64/x86_64)**: ホットな関数は、呼び出し回数またはバックエッジ回数がしきい値を超えるとネイティブコードにコンパイルされます。

### JIT が発動する条件

- **呼び出しのしきい値**: 同じ関数が約8回呼び出された後
- **バックエッジカウント**: ホットなループは JIT をより早くトリガーします（ループの反復回数がしきい値にカウントされます）
- **適応型**: しきい値は関数の特性に基づいて調整されます

JIT コンパイルが完了すると、その関数への以降のすべての呼び出しはインタープリタをバイパスし、ネイティブマシンコードを直接実行します。

## バイナリサイズとメモリ

| 指標 | 値 |
|------|-----|
| バイナリサイズ (ReleaseSafe) | 1.28 MB |
| ランタイムメモリ (fib ベンチマーク) | 3.57 MB RSS |
| wasmtime バイナリ（比較用） | 56.3 MB |

zwasm は wasmtime の約1/44のサイズです。

## ベンチマーク結果

Apple M4 Pro 上で zwasm を wasmtime、Bun、Node.js と比較した代表的なベンチマーク:

| ベンチマーク | zwasm | wasmtime | Bun | Node |
|-------------|-------|----------|-----|------|
| fib(35) | 54 ms | 51 ms | 33 ms | 44 ms |
| tak(24,16,8) | 7 ms | 11 ms | 17 ms | 26 ms |
| sieve(1M) | 4 ms | 6 ms | 16 ms | 27 ms |
| nbody(1M) | 10 ms | 21 ms | 33 ms | 34 ms |
| nqueens(8) | 2 ms | 5 ms | 14 ms | 22 ms |

zwasm はほとんどのベンチマークで wasmtime と同等の性能を示し、いくつかのベンチマークではより高速でありながら、メモリ使用量はごくわずかです。

## ベンチマーク手法

すべての測定は [hyperfine](https://github.com/sharkdp/hyperfine) を使用し、ReleaseSafe ビルドで行っています:

```bash
# クイックチェック（1回実行、ウォームアップなし）
bash bench/run_bench.sh --quick

# 完全な測定（3回実行、1回ウォームアップ）
bash bench/run_bench.sh

# 履歴に記録
bash bench/record.sh --id="X" --reason="description"
```

### ベンチマークレイヤー

| レイヤー | 数 | 説明 |
|---------|-----|------|
| WAT micro | 5 | 手書き: fib, tak, sieve, nbody, nqueens |
| TinyGo | 11 | TinyGo コンパイラ出力: 同じアルゴリズム + 文字列操作 |
| Shootout | 5 | Sightglass shootout スイート (WASI) |
| GC | 2 | GC プロポーザル: 構造体アロケーション、木の走査 |

### CI によるリグレッション検出

PR は自動的にパフォーマンスリグレッションがチェックされます:
- 6つの代表的なベンチマークがベースブランチと PR ブランチの両方で実行されます
- いずれかのベンチマークが20%以上リグレッションした場合、失敗となります
- 同一ランナーにより公平な比較が保証されます

## パフォーマンスのヒント

- **ReleaseSafe**: 本番環境では必ず使用してください。Debug は5〜10倍遅くなります。
- **ホットな関数**: 頻繁に呼び出される関数は自動的に JIT コンパイルされます。
- **Fuel 制限**: `--fuel` は命令ごとにオーバーヘッドが加わります。信頼できないコードにのみ使用してください。
- **メモリ**: リニアメモリを持つ Wasm モジュールはガードページを割り当てます。初期 RSS はモジュールサイズに関係なく約 3.5 MB です。
