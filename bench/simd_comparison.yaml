# SIMD Performance Baseline: zwasm vs wasmtime
# Recorded: 2026-02-17
# Platform: macOS aarch64 (Apple Silicon)
# zwasm: v1.0.0 (ReleaseSafe), wasmtime: v41.0.1
# Methodology: hyperfine --warmup 3 --runs 10
# Note: zwasm SIMD uses stack interpreter (no RegIR/JIT for v128 functions)
#       wasmtime uses Cranelift JIT with NEON SIMD lowering

benchmarks:

  dot_product:
    description: "f32 dot product, N=4096 elements, 10000 iterations"
    wat_file: bench/simd/dot_product.wat
    verification: 4096  # both scalar and simd return same value
    scalar:
      zwasm_ms: 126.3
      wasmtime_ms: 33.3
      ratio: 3.79  # wasmtime faster
    simd:
      zwasm_ms: 862.7
      wasmtime_ms: 11.2
      ratio: 77.24  # wasmtime faster
    zwasm_simd_vs_scalar: 6.83  # SIMD is 6.8x slower than scalar in zwasm
    wasmtime_simd_vs_scalar: 0.34  # SIMD is 3.0x faster than scalar in wasmtime

  matrix_mul:
    description: "f32 16x16 matrix multiply, 1000 iterations"
    wat_file: bench/simd/matrix_mul.wat
    verification: 0.1496
    note: "16x16 (not 32x32+) due to JIT nested loop bug W34"
    scalar:
      zwasm_ms: 7.7
      wasmtime_ms: 6.0
      ratio: 1.27  # wasmtime faster
    simd:
      zwasm_ms: 133.7
      wasmtime_ms: 6.1
      ratio: 21.92  # wasmtime faster
    zwasm_simd_vs_scalar: 17.36  # SIMD is 17.4x slower than scalar in zwasm
    wasmtime_simd_vs_scalar: 1.02  # SIMD ~same as scalar in wasmtime (small matrix)

  byte_search:
    description: "byte search in 64KB buffer, 1000 iterations, target=42"
    wat_file: bench/simd/byte_search.wat
    verification: 256  # count of target byte occurrences
    scalar:
      zwasm_ms: 26.5
      wasmtime_ms: 25.9
      ratio: 1.02  # wasmtime faster (nearly equal)
    simd:
      zwasm_ms: 388.8
      wasmtime_ms: 8.5
      ratio: 45.48  # wasmtime faster
    zwasm_simd_vs_scalar: 14.67  # SIMD is 14.7x slower than scalar in zwasm
    wasmtime_simd_vs_scalar: 0.33  # SIMD is 3.0x faster than scalar in wasmtime

  image_blend:
    description: "128x128 RGBA image blend (50% alpha), 1000 iterations"
    wat_file: bench/simd/image_blend.wat
    verification: "scalar=127, simd=128 (avgr_u rounding)"
    scalar:
      zwasm_ms: 53.8
      wasmtime_ms: 32.0
      ratio: 1.68  # wasmtime faster
    simd:
      zwasm_ms: 333.1
      wasmtime_ms: 7.6
      ratio: 43.93  # wasmtime faster
    zwasm_simd_vs_scalar: 6.19  # SIMD is 6.2x slower than scalar in zwasm
    wasmtime_simd_vs_scalar: 0.24  # SIMD is 4.2x faster than scalar in wasmtime

summary:
  # Scalar performance: zwasm vs wasmtime
  scalar_ratios:
    dot_product: 3.79x
    matrix_mul: 1.27x
    byte_search: 1.02x
    image_blend: 1.68x
    geometric_mean: 1.69x  # wasmtime scalar ~1.7x faster (JIT vs interpreter+JIT)

  # SIMD performance: zwasm vs wasmtime
  simd_ratios:
    dot_product: 77.24x
    matrix_mul: 21.92x
    byte_search: 45.48x
    image_blend: 43.93x
    geometric_mean: 42.8x  # wasmtime SIMD ~43x faster

  # Key insight: zwasm SIMD is SLOWER than zwasm scalar (dispatch overhead)
  # while wasmtime SIMD is FASTER than wasmtime scalar (NEON acceleration)
  zwasm_simd_penalty:
    dot_product: 6.83x
    matrix_mul: 17.36x
    byte_search: 14.67x
    image_blend: 6.19x
    geometric_mean: 10.2x  # SIMD ~10x slower than scalar in zwasm

  wasmtime_simd_speedup:
    dot_product: 2.97x
    matrix_mul: 0.98x  # ~parity (matrix too small to amortize)
    byte_search: 3.05x
    image_blend: 4.21x
    geometric_mean: 2.47x  # SIMD ~2.5x faster than scalar in wasmtime
